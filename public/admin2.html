<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>STNSL.999 â€“ Tela</title>

  <!-- Bootstrap & FontAwesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    :root {
      --bg-1: #0e131a;
      --bg-2: #161c24;
      --stroke: #1f2731;
      --text: #d0d5dc;
      --brand: #3ddcff;
      --radius: .6rem;
      --shadow: 0 8px 24px -12px rgba(0,0,0,.6);
      --mono: 'Fira Code', Consolas, Menlo, monospace;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: var(--mono);
      background: var(--bg-1);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }
    *::-webkit-scrollbar { width: 6px; height: 6px; }
    *::-webkit-scrollbar-thumb { background: var(--brand); border-radius: 3px; }

    .sidebar {
      background: var(--bg-2);
      width: 240px;
      border-right: 1px solid var(--stroke);
      overflow-y: auto;
    }
    .brand {
      padding: 1.5rem 1rem .75rem;
      border-bottom: 1px solid var(--stroke);
      text-align: center;
    }
    .brand img { max-height: 78px; }

    .list-group-item {
      display: flex;
      align-items: center;
      gap: .75rem;
      padding: .55rem .85rem;
      font-size: .9rem;
      color: var(--text);
      background: transparent;
      border: 0;
      border-bottom: 1px solid var(--stroke);
    }
    .list-group-item:last-child { border-bottom: none; }
    .list-group-item .btn { font-size: .85rem; }

    #viewer {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px,1fr));
      gap: 1.2rem;
      padding: 1.5rem;
    }
    .card-feed {
      position: relative;
      background: var(--bg-2);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    .card-feed img {
      display: block;
      width: 100%;
      height: 170px;
      object-fit: cover;
      filter: brightness(.92);
    }
    .card-feed .ip-label {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      padding: .25rem .5rem;
      font-size: .75rem;
      font-weight: 600;
      background: rgba(14,19,26,.9);
      color: var(--brand);
      text-align: center;
    }
    .card-feed .overlay {
      position: absolute;
      bottom: .4rem; left: .5rem;
      padding: .2rem .6rem;
      font-size: .75rem;
      background: rgba(0,0,0,.65);
      color: #fff;
      border-radius: .3rem;
      text-transform: uppercase;
    }
    .card-feed .btn-bar {
      position: absolute;
      top: .4rem; right: .4rem;
      display: flex;
      gap: .4rem;
      z-index: 2;
    }
    .btn-glass {
      width: 32px; height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(61,220,255,.1);
      border: 1px solid rgba(61,220,255,.28);
      color: var(--brand);
      border-radius: 50%;
      backdrop-filter: blur(3px);
      cursor: pointer;
    }
    .btn-glass:hover {
      background: rgba(61,220,255,.18);
      border-color: rgba(61,220,255,.45);
    }

    /* Fullscreen styles */
    .card-feed:fullscreen,
    .card-feed:-webkit-full-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      background: black;
    }
    .card-feed:fullscreen img,
    .card-feed:-webkit-full-screen img {
      width: auto !important;
      height: auto !important;
      max-width: 100% !important;
      max-height: 100% !important;
      object-fit: contain !important;
    }
  </style>
</head>

<body>
  <div class="d-flex" style="height:100vh">
    <!-- Sidebar -->
    <aside class="sidebar p-3">
      <div class="brand">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRt0Knrsk0bL7_3EMrM_TE7G5GCp6RDVgMdRQ&s" alt="Sala do Futuro">
      </div>
      <h6 class="fw-semibold mt-4">
        Dispositivos <span id="count" class="badge bg-primary">0</span>
      </h6>
      <ul id="list" class="list-group list-group-flush small mt-2"></ul>
    </aside>

    <!-- Viewer -->
    <main class="flex-grow-1 overflow-auto">
      <div id="viewer"></div>
    </main>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io({ query: { role: 'admin' } });
    const listEl = document.getElementById('list');
    const viewer = document.getElementById('viewer');
    const activeScreen = {};

    function openFullScreen(card) {
      (card.requestFullscreen ||
       card.webkitRequestFullscreen ||
       card.msRequestFullscreen).call(card);
    }

    function mkScreenCard(uuid, data) {
      let card = document.getElementById('screen-' + uuid);
      if (!card) {
        card = document.createElement('div');
        card.className = 'card-feed';
        card.id = 'screen-' + uuid;
        card.innerHTML = `
          <div class="ip-label">${uuid}</div>
          <img id="img-${uuid}">
          <div class="overlay">Tela</div>
          <div class="btn-bar">
            <button class="btn-glass btn-full"><i class="fas fa-expand"></i></button>
            <button class="btn-glass btn-close"><i class="fas fa-xmark"></i></button>
          </div>
        `;
        card.querySelector('.btn-full').onclick = () => openFullScreen(card);
        card.querySelector('.btn-close').onclick = () => {
          socket.emit('stop-screen', uuid);
          delete activeScreen[uuid];
          card.remove();
          const toggleBtn = document.querySelector(`.toggle-screen[data-uuid="${uuid}"]`);
          if (toggleBtn) {
            toggleBtn.textContent = '';
            toggleBtn.insertAdjacentHTML('afterbegin', '<i class="fas fa-desktop me-1"></i>Tela');
            toggleBtn.disabled = false;
          }
        };
        viewer.appendChild(card);
      }
      document.getElementById('img-' + uuid).src = data;
    }

    socket.on('clients', arr => {
      document.getElementById('count').textContent = arr.length;
      listEl.innerHTML = '';
      arr.forEach(c => {
        listEl.insertAdjacentHTML('beforeend', `
          <li class="list-group-item" data-uuid="${c.uuid}">
            <span>${c.ip}</span>
            <button class="btn btn-sm btn-primary ms-auto toggle-screen" data-uuid="${c.uuid}">
              <i class="fas fa-desktop me-1"></i>Tela
            </button>
          </li>
        `);
      });
    });

    listEl.addEventListener('click', e => {
      const btn = e.target.closest('.toggle-screen');
      if (!btn) return;
      const uuid = btn.getAttribute('data-uuid');
      if (activeScreen[uuid]) {
        // fechar via sidebar
        document.getElementById('screen-' + uuid)?.querySelector('.btn-close')?.click();
      } else {
        socket.emit('request-screen', uuid);
        activeScreen[uuid] = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>...';
        btn.disabled = true;
      }
    });

    socket.on('screen-frame', ({ id, data }) => {
      if (activeScreen[id]) mkScreenCard(id, data);
    });
  </script>
</body>
</html>